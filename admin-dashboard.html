<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Magic - Admin Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="admin-common.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-light bg-white px-4 shadow-sm">
    <a class="navbar-brand">Meal Magic</a>
    <button class="btn btn-danger logout-btn" data-bs-toggle="modal" data-bs-target="#logoutModal">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </nav>

  <div class="container mt-4">
    <h3 class="fw-bold">Admin Dashboard</h3>
    <p class="text-muted">Manage your menu items</p>

    <!-- Top Navigation Buttons -->
    <div class="top-nav d-flex gap-2 flex-wrap mb-4">
      <a class="btn btn-outline-primary active" href="admin-dashboard.html"><i class="fas fa-utensils"></i> Menu</a>
      <a class="btn btn-outline-secondary" href="admin-orders.html"><i class="fas fa-shopping-cart"></i> Orders</a>
      <a class="btn btn-outline-secondary" href="users.html"><i class="fas fa-users"></i> Users</a>
      <a class="btn btn-outline-secondary" href="revenue.html"><i class="fas fa-chart-line"></i> Revenue</a>
    </div>

    <!-- Menu Management -->
    <div>
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h5><i class="fas fa-list"></i> Menu Items</h5>
          <button class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addDishModal">
            <i class="fas fa-plus"></i> Add New Dish
          </button>
        </div>
        
        <!-- Search and Filter Bar -->
        <div class="card mb-3">
          <div class="card-body">
            <div class="row">
              <div class="col-md-6">
                <input type="text" class="form-control" id="searchInput" placeholder="Search by dish name...">
              </div>
              <div class="col-md-3">
                <select class="form-select" id="availabilityFilter">
                  <option value="">All Status</option>
                  <option value="true">Available</option>
                  <option value="false">Unavailable</option>
                </select>
              </div>
              <div class="col-md-3">
                <button class="btn btn-outline-secondary" onclick="clearFilters()">
                  <i class="fas fa-times"></i> Clear Filters
                </button>
              </div>
            </div>
          </div>
        </div>
        
        <div class="card shadow-sm p-3">
          <div class="table-responsive">
            <table class="table align-middle">
              <thead>
                <tr>
                  <th>
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('id')">
                      ID <i class="fas fa-sort" id="sort-id"></i>
                    </button>
                  </th>
                  <th>
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('name')">
                      Dish Name <i class="fas fa-sort" id="sort-name"></i>
                    </button>
                  </th>
                  <th>
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('price')">
                      Price <i class="fas fa-sort" id="sort-price"></i>
                    </button>
                  </th>
                  <th>
                    <button class="btn btn-link p-0 text-decoration-none" onclick="sortTable('availability')">
                      Availability <i class="fas fa-sort" id="sort-availability"></i>
                    </button>
                  </th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="menu-table"></tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <nav aria-label="Menu pagination">
            <ul class="pagination justify-content-center" id="pagination"></ul>
          </nav>
        </div>
    </div>
  </div>
<div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content text-center">
<div class="modal-body p-4">
<p class="fs-5 mb-4">Are you sure you want to logout?</p>
<button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
<button type="button" id="confirmLogout" class="btn btn-danger">Yes, Logout</button>
</div>
</div>
</div>
</div>

<!-- Add/Edit Dish Modal -->
<div class="modal fade" id="addDishModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="dishModalTitle">Add New Dish</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<form id="dishForm">
<div class="row">
<div class="col-md-6">
<div class="mb-3"><label class="form-label">Dish Name</label><input type="text" class="form-control" id="dishName" required></div>
<div class="mb-3"><label class="form-label">Cuisine</label><input type="text" class="form-control" id="dishCuisine" required></div>
<div class="mb-3"><label class="form-label">Price</label><input type="number" class="form-control" id="dishPrice" step="0.01" min="0" required></div>
</div>
<div class="col-md-6">
<div class="mb-3"><label class="form-label">Description</label><textarea class="form-control" id="dishDescription" rows="3" required></textarea></div>
<div class="mb-3"><label class="form-label">Cover Image URL</label><input type="url" class="form-control" id="dishImage" required></div>
<div class="mb-3"><div class="form-check"><input class="form-check-input" type="checkbox" id="dishAvailable" checked><label class="form-check-label">Available</label></div></div>
</div>
</div>
</form>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-success" onclick="saveDish()">Save Dish</button>
</div>
</div>
</div>
</div>

<!-- View Dish Modal -->
<div class="modal fade" id="dishModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="modalDishName"></h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body text-center" id="dishModalBody"></div>
</div>
</div>
</div>
<!-- View Order Details Modal -->
<div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="orderModalTitle">Order Details</h5>
<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body" id="orderModalBody"></div>
</div>
</div>
</div>
<!-- Success Modal -->
<div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-body text-center p-4">
<div class="mb-3"><i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i></div>
<h5 class="mb-3" id="successTitle">Success!</h5>
<p class="mb-4" id="successMessage"></p>
<button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
</div>
</div>
</div>
</div>
<!-- Error Modal -->
<div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-body text-center p-4">
<div class="mb-3"><i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i></div>
<h5 class="mb-3" id="errorTitle">Error!</h5>
<p class="mb-4" id="errorMessage"></p>
<button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
</div>
</div>
</div>
</div>
<!-- Confirmation Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-body text-center p-4">
<div class="mb-3"><i class="fas fa-question-circle text-warning" style="font-size: 3rem;"></i></div>
<h5 class="mb-3" id="confirmTitle">Confirm Action</h5>
<p class="mb-4" id="confirmMessage"></p>
<div class="d-flex justify-content-center gap-3">
<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-danger" id="confirmAction">Confirm</button>
</div>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="admin-shared.js"></script>
  <script>
    let dishes = [], currentEditingDish = null,
        filteredDishes = [], currentPage = 1, itemsPerPage = 5,
        currentSort = { column: null, direction: 'asc' };

    const tableBody = document.getElementById("menu-table"),
          dishModal = new bootstrap.Modal(document.getElementById('dishModal')),
          addDishModal = new bootstrap.Modal(document.getElementById('addDishModal')),
          successModal = new bootstrap.Modal(document.getElementById('successModal')),
          errorModal = new bootstrap.Modal(document.getElementById('errorModal')),
          confirmModal = new bootstrap.Modal(document.getElementById('confirmModal')),
          modalTitleEl = document.getElementById('modalDishName'),
          modalBodyEl = document.getElementById('dishModalBody'),
          noop = null;

    // Use shared modal helpers via AdminShared

    // Initialize Menu page
    async function initializeApp() {
      await loadDishes();
      setupEventListeners();
    }

    // Setup event listeners for search and filters
    function setupEventListeners() {
      document.getElementById('searchInput').addEventListener('input', filterDishes);
      document.getElementById('availabilityFilter').addEventListener('change', filterDishes);
    }

    // Load dishes
    async function loadDishes() {
      try {
        const response = await fetch('http://localhost:3001/dish/getAllDishes');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const dishesData = await response.json();
        dishes = dishesData.map(dish => ({
          id: dish._id,
          name: dish.dishName,
          cuisine: dish.cuisine,
          price: dish.price,
          availability: dish.isAvailable ? 'Available' : 'Unavailable',
          image: dish.coverImage,
          description: dish.description,
          isAvailable: dish.isAvailable
        }));
        filterDishes();
      } catch (error) {
        console.error("Could not fetch dish data:", error);
        tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load menu data.</td></tr>';
      }
    }

    // Filter dishes based on search and filters
    function filterDishes() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      const availabilityFilter = document.getElementById('availabilityFilter').value;
      
      filteredDishes = dishes.filter(dish => {
        const matchesSearch = dish.name.toLowerCase().includes(searchTerm);
        const matchesAvailability = !availabilityFilter || dish.isAvailable.toString() === availabilityFilter;
        return matchesSearch && matchesAvailability;
      });
      
      currentPage = 1;
      renderDishesTable();
    }

    // Clear all filters
    function clearFilters() {
      document.getElementById('searchInput').value = '';
      document.getElementById('availabilityFilter').value = '';
      filterDishes();
    }

    // Sort table
    function sortTable(column) {
      if (currentSort.column === column) {
        currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
      } else {
        currentSort.column = column;
        currentSort.direction = 'asc';
      }

      // Update sort icons
      document.querySelectorAll('[id^="sort-"]').forEach(icon => {
        icon.className = 'fas fa-sort';
      });

      const sortIcon = document.getElementById(`sort-${column}`);
      sortIcon.className = currentSort.direction === 'asc' ? 'fas fa-sort-up' : 'fas fa-sort-down';

      // Sort filtered dishes
      filteredDishes.sort((a, b) => {
        let aVal, bVal;
        
        switch (column) {
          case 'id':
            aVal = dishes.indexOf(a) + 1;
            bVal = dishes.indexOf(b) + 1;
            break;
          case 'name':
            aVal = a.name.toLowerCase();
            bVal = b.name.toLowerCase();
            break;
          case 'price':
            aVal = a.price;
            bVal = b.price;
            break;
          case 'availability':
            aVal = a.availability;
            bVal = b.availability;
            break;
          default:
            return 0;
        }

        if (aVal < bVal) return currentSort.direction === 'asc' ? -1 : 1;
        if (aVal > bVal) return currentSort.direction === 'asc' ? 1 : -1;
        return 0;
      });

      currentPage = 1;
      renderDishesTable();
    }

    // Render dishes table with pagination
    function renderDishesTable() {
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const currentDishes = filteredDishes.slice(startIndex, endIndex);

      tableBody.innerHTML = currentDishes.map((dish, index) => {
        const globalIndex = dishes.indexOf(dish) + 1;
        return `
          <tr>
            <td>${globalIndex}</td>
            <td>${dish.name}</td>
            <td>$${dish.price.toFixed(2)}</td>
            <td class="${dish.availability === 'Available' ? 'text-success' : 'text-danger'}">${dish.availability}</td>
            <td>
              <div class="btn-group" role="group">
                <button class="btn btn-sm btn-info show-more-btn" data-id="${dish.id}">View</button>
                <button class="btn btn-sm btn-warning edit-dish-btn" data-id="${dish.id}">Edit</button>
                <button class="btn btn-sm btn-danger delete-dish-btn" data-id="${dish.id}">Delete</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');

      renderPagination();
    }

    // Render pagination
    function renderPagination() {
      const totalPages = Math.ceil(filteredDishes.length / itemsPerPage);
      const pagination = document.getElementById('pagination');
      
      if (totalPages <= 1 || filteredDishes.length === 0) {
        pagination.innerHTML = '';
        return;
      }

      let paginationHTML = '';

      // Previous button
      paginationHTML += `
        <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a>
        </li>
      `;

      // Page numbers - show up to 5 pages only
      const startPage = Math.max(1, currentPage - 2);
      const endPage = Math.min(totalPages, startPage + 4);
      
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <li class="page-item ${i === currentPage ? 'active' : ''}">
            <a class="page-link" href="#" onclick="changePage(${i})">${i}</a>
          </li>
        `;
      }

      // Next button
      paginationHTML += `
        <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
          <a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a>
        </li>
      `;

      pagination.innerHTML = paginationHTML;
    }

    // Change page
    function changePage(page) {
      const totalPages = Math.ceil(filteredDishes.length / itemsPerPage);
      if (page >= 1 && page <= totalPages) {
        currentPage = page;
        renderDishesTable();
      }
    }

    // Helpers kept page-local only for Menu page

    // Save dish (add or edit)
    async function saveDish() {
      const dishData = {
        dishName: document.getElementById('dishName').value,
        cuisine: document.getElementById('dishCuisine').value,
        price: parseFloat(document.getElementById('dishPrice').value),
        description: document.getElementById('dishDescription').value,
        coverImage: document.getElementById('dishImage').value,
        isAvailable: document.getElementById('dishAvailable').checked
      };

      try {
        let response;
        if (currentEditingDish) {
          // Edit existing dish
          response = await fetch(`http://localhost:3001/dish/updateDish/${currentEditingDish}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dishData)
          });
        } else {
          // Add new dish
          response = await fetch('http://localhost:3001/dish/addDish', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(dishData)
          });
        }

        if (response.ok) {
          addDishModal.hide();
          clearDishForm();
          await loadDishes();
          window.AdminShared.showSuccessModal('Success!', currentEditingDish ? 'Dish updated successfully!' : 'Dish added successfully!');
        } else {
          window.AdminShared.showErrorModal('Error!', 'Failed to save dish');
        }
      } catch (error) {
        console.error('Error saving dish:', error);
        window.AdminShared.showErrorModal('Network Error', 'Network error. Please try again.');
      }
    }


    // Clear dish form
    function clearDishForm() {
      document.getElementById('dishForm').reset();
      currentEditingDish = null;
      document.getElementById('dishModalTitle').textContent = 'Add New Dish';
    }

    window.AdminShared.bindLogout('logoutModal', 'confirmLogout');

    // Table event listeners
    tableBody.addEventListener('click', function(event) {
      const dishId = event.target.dataset.id;
      
        if (event.target.classList.contains('show-more-btn')) {
        const dish = dishes.find(d => d.id === dishId);
            if (!dish) return;

            modalTitleEl.textContent = dish.name;
            modalBodyEl.innerHTML = `
                <img src="${dish.image}" class="img-fluid rounded mb-3" alt="${dish.name}">
                <p class="small"><strong>Cuisine:</strong> ${dish.cuisine}</p>
                <p class="small"><strong>Price:</strong> $${dish.price.toFixed(2)}</p>
                <p class="small"><strong>Availability:</strong> 
                    <span class="${dish.availability === 'Available' ? 'text-success' : 'text-danger'} fw-bold">${dish.availability}</span>
                </p>
                <p class="small text-muted"><strong>Description:</strong> ${dish.description}</p>
            `;
            dishModal.show();
      } else if (event.target.classList.contains('edit-dish-btn')) {
        const dish = dishes.find(d => d.id === dishId);
        if (!dish) return;

        currentEditingDish = dishId;
        document.getElementById('dishModalTitle').textContent = 'Edit Dish';
        document.getElementById('dishName').value = dish.name;
        document.getElementById('dishCuisine').value = dish.cuisine;
        document.getElementById('dishPrice').value = dish.price;
        document.getElementById('dishDescription').value = dish.description;
        document.getElementById('dishImage').value = dish.image;
        document.getElementById('dishAvailable').checked = dish.isAvailable;
        addDishModal.show();
      } else if (event.target.classList.contains('delete-dish-btn')) {
        window.AdminShared.showConfirmModal('Delete Dish', 'Are you sure you want to delete this dish?', () => {
          deleteDish(dishId);
        });
      }
    });

    // Delete dish function
    async function deleteDish(dishId) {
      try {
        const response = await fetch(`http://localhost:3001/dish/deleteDish/${dishId}`, {
          method: 'DELETE'
        });

        if (response.ok) {
          await loadDishes();
          window.AdminShared.showSuccessModal('Success!', 'Dish deleted successfully!');
        } else {
          window.AdminShared.showErrorModal('Error!', 'Failed to delete dish');
        }
      } catch (error) {
        console.error('Error deleting dish:', error);
        window.AdminShared.showErrorModal('Network Error', 'Network error. Please try again.');
      }
    }

    // Initialize the page
    initializeApp();
  </script>
</body>
</html>


