<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Magic - Revenue</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="admin-common.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-light bg-white px-4 shadow-sm">
    <a class="navbar-brand" href="admin-dashboard.html">Meal Magic</a>
    <button class="btn btn-danger logout-btn" data-bs-toggle="modal" data-bs-target="#logoutModal">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </nav>

  <div class="container mt-4">
    <h3 class="fw-bold">Revenue Analytics</h3>
    <p class="text-muted">Track totals and recent orders</p>

    <!-- Top Navigation Buttons -->
    <div class="top-nav d-flex gap-2 flex-wrap mb-4">
      <a class="btn btn-outline-secondary" href="admin-dashboard.html"><i class="fas fa-utensils"></i> Menu</a>
      <a class="btn btn-outline-secondary" href="admin-orders.html"><i class="fas fa-shopping-cart"></i> Orders</a>
      <a class="btn btn-outline-secondary" href="users.html"><i class="fas fa-users"></i> Users</a>
      <a class="btn btn-outline-primary active" href="revenue.html"><i class="fas fa-chart-line"></i> Revenue</a>
    </div>

    <div class="row">
      <div class="col-md-6">
        <div class="card shadow-sm p-3 mb-3">
          <h6 class="card-title">Total Revenue</h6>
          <h3 class="text-success" id="total-revenue">$0.00</h3>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card shadow-sm p-3 mb-3">
          <h6 class="card-title">Total Orders</h6>
          <h3 class="text-primary" id="total-orders">0</h3>
        </div>
      </div>
    </div>

    <div class="card shadow-sm p-3">
      <h6>Recent Orders</h6>
      <div class="table-responsive">
        <table class="table table-sm">
          <thead><tr><th>Order ID</th><th>Customer</th><th>Amount</th><th>Status</th><th>Date</th></tr></thead>
          <tbody id="recent-orders-table"><tr><td colspan="5" class="text-center">Loading...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-body p-4">
          <p class="fs-5 mb-4">Are you sure you want to logout?</p>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmLogout" class="btn btn-danger">Yes, Logout</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="admin-shared.js"></script>
  <script>
    let orders = [];
    const recentOrdersTableBody = document.getElementById('recent-orders-table');

    async function loadOrders() {
      try {
        const response = await fetch('http://localhost:3001/order/getAllOrders');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        orders = await response.json();
        renderRevenue();
        renderRecentOrdersTable();
      } catch (error) {
        console.error('Could not fetch orders:', error);
        recentOrdersTableBody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Failed to load.</td></tr>';
      }
    }

    const getStatusColor = window.AdminShared.getStatusColor;

    function renderRevenue() {
      const totalRevenue = orders.reduce((sum, order) => sum + order.totalAmount, 0);
      document.getElementById('total-revenue').textContent = `$${totalRevenue.toFixed(2)}`;
      document.getElementById('total-orders').textContent = orders.length;
    }

    function renderRecentOrdersTable() {
      const recentOrders = orders.slice(0, 10);
      recentOrdersTableBody.innerHTML = recentOrders.map(order => `
        <tr>
          <td>${order._id.substring(0, 8)}...</td>
          <td>${order.user ? order.user.username : 'N/A'}</td>
          <td>$${order.totalAmount.toFixed(2)}</td>
          <td><span class="badge bg-${getStatusColor(order.orderStatus)}">${order.orderStatus}</span></td>
          <td>${new Date(order.createdAt).toLocaleDateString()}</td>
        </tr>`).join('');
    }

    window.AdminShared.bindLogout('logoutModal', 'confirmLogout');

    loadOrders();
  </script>
</body>
</html>


