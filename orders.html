<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Food Orders</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    body { background-color: #f8f9fa; }
    .table-header-orange th {
      background-color: #E96A36;
      color: white;
    }
    
    /* Modal Styles */
    .modal-content {
      border: none;
      border-radius: 12px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }
    
    .form-control:focus {
      border-color: #E96A36;
      box-shadow: 0 0 0 0.2rem rgba(233, 106, 54, 0.25);
    }
    
    .btn-primary-modal {
      background-color: #E96A36;
      border-color: #E96A36;
    }
    
    .btn-primary-modal:hover {
      background-color: #d55a2b;
      border-color: #d55a2b;
    }
    
    .modal-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="d-flex align-items-center justify-content-center min-vh-100 p-3">

  <div class="card shadow-sm border-0 rounded-4 p-4 p-md-5" style="max-width: 700px; width: 100%;">
    <header class="text-center mb-4">
      <h1 class="display-4">üçΩ</h1>
      <h2 class="fw-bold">Your Food Orders</h2>
      <p class="text-muted">Review the delicious dishes you've added to your cart</p>
    </header>

    <main>
      <div class="table-responsive">
        <table class="table table-borderless align-middle mb-0">
          <thead class="table-header-orange">
            <tr>
              <th scope="col" class="text-uppercase small rounded-start-3 ps-3">Dish Name</th>
              <th scope="col" class="text-uppercase small">Price</th>
              <th scope="col" class="text-uppercase small text-center rounded-end-3">Action</th>
            </tr>
          </thead>
          <tbody id="orders-body"></tbody>
        </table>
      </div>
    </main>

    <footer class="d-flex justify-content-between align-items-center pt-4 mt-4 border-top">
      <h5 class="fw-bold mb-0">
        Total Price: <span id="total-price" class="text-success">$0.00</span>
      </h5>
      <div>
        <button class="btn btn-success me-2" onclick="placeOrder()" id="place-order-btn">
          <i class="fas fa-shopping-cart"></i> Place Order
        </button>
        <a href="user-dashboard.html" class="btn btn-light">&larr; Back to Menu</a>
      </div>
    </footer>
  </div>

  <!-- Universal Modal -->
  <div class="modal fade" id="universalModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle"></h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="modalBody"></div>
        <div class="modal-footer" id="modalFooter"></div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const ordersBody = document.getElementById("orders-body");
    const totalPriceElement = document.getElementById("total-price");
    let cart = JSON.parse(localStorage.getItem("cart")) || [];
    let total = 0;

    function renderCart() {
      ordersBody.innerHTML = "";
      total = 0;
      cart.forEach((item, index) => {
        const itemTotal = Number(item.price) * (item.quantity || 1);
        total += itemTotal;
        const row = document.createElement("tr");
        row.classList.add("border-bottom");
        row.innerHTML = `
          <td class="ps-3">
            <div class="d-flex align-items-center">
              <img src="${item.image || ''}" alt="${item.name}" class="me-2" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">
              <div>
                <div class="fw-semibold">${item.name}</div>
                <small class="text-muted">Qty: ${item.quantity || 1}</small>
              </div>
            </div>
          </td>
          <td class="fw-semibold">$${itemTotal.toFixed(2)}</td>
          <td class="text-center">
            <div class="btn-group" role="group">
              <button class="btn btn-outline-secondary btn-sm" onclick="decreaseQuantity(${index})">-</button>
              <span class="btn btn-outline-secondary btn-sm disabled">${item.quantity || 1}</span>
              <button class="btn btn-outline-secondary btn-sm" onclick="increaseQuantity(${index})">+</button>
              <button class="btn btn-danger btn-sm ms-1" onclick="removeItem(${index})">Delete</button>
            </div>
          </td>
        `;
        ordersBody.appendChild(row);
      });
      totalPriceElement.textContent = "$" + total.toFixed(2);
    }

    function removeItem(index) {
      cart.splice(index, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function increaseQuantity(index) {
      cart[index].quantity = (cart[index].quantity || 1) + 1;
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function decreaseQuantity(index) {
      if (cart[index].quantity > 1) {
        cart[index].quantity -= 1;
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      } else {
        removeItem(index);
      }
    }

    let currentStep = 0;
    let orderData = {};

    function showModal(title, body, footer) {
      document.getElementById('modalTitle').innerHTML = title;
      document.getElementById('modalBody').innerHTML = body;
      document.getElementById('modalFooter').innerHTML = footer;
      new bootstrap.Modal(document.getElementById('universalModal')).show();
    }

    function placeOrder() {
      if (cart.length === 0) {
        showModal(
          '<i class="fas fa-shopping-cart me-2 text-warning"></i>Empty Cart',
          '<div class="text-center"><div class="modal-icon text-warning"><i class="fas fa-shopping-cart"></i></div><h4 class="mb-3">Your cart is empty!</h4><p class="text-muted">Add some delicious dishes to your cart before placing an order.</p></div>',
          '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><a href="user-dashboard.html" class="btn btn-primary-modal">Browse Menu</a>'
        );
        return;
      }

      let userData = {};
      try {
        const userString = localStorage.getItem('user');
        if (userString && userString !== 'undefined' && userString !== 'null') {
          userData = JSON.parse(userString);
        }
      } catch (error) {
        console.error('Error parsing user data:', error);
        userData = {};
      }
      if (!userData.id) {
        showModal(
          '<i class="fas fa-exclamation-triangle me-2 text-danger"></i>Login Required',
          '<div class="text-center"><div class="modal-icon text-danger"><i class="fas fa-exclamation-triangle"></i></div><h4 class="mb-3">Please login to place an order</h4><p class="text-muted">You will be redirected to the login page.</p></div>',
          '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>'
        );
        setTimeout(() => window.location.href = 'login.html', 2000);
        return;
      }

      currentStep = 1;
      showDeliveryModal();
    }

    function showDeliveryModal() {
      showModal(
        '<i class="fas fa-truck me-2"></i>Delivery Address',
        '<div class="mb-3"><label for="shippingAddress" class="form-label">Delivery Address *</label><textarea class="form-control" id="shippingAddress" rows="3" placeholder="Enter your complete delivery address..." required></textarea></div>',
        '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="button" class="btn btn-primary-modal" onclick="proceedToBilling()">Next</button>'
      );
    }

    function proceedToBilling() {
      const shippingAddress = document.getElementById('shippingAddress').value.trim();
      if (!shippingAddress) {
        document.getElementById('shippingAddress').focus();
        return;
      }
      orderData.shippingAddress = shippingAddress;
      currentStep = 2;
      showBillingModal();
    }

    function showBillingModal() {
      showModal(
        '<i class="fas fa-credit-card me-2"></i>Billing Address',
        '<div class="mb-3"><label for="billingAddress" class="form-label">Billing Address</label><textarea class="form-control" id="billingAddress" rows="3" placeholder="Enter your billing address (or leave blank to use delivery address)..."></textarea><div class="form-text">Leave blank to use the same address as delivery</div></div>',
        '<button type="button" class="btn btn-secondary" onclick="showDeliveryModal()">Back</button><button type="button" class="btn btn-primary-modal" onclick="confirmOrder()">Place Order</button>'
      );
    }

    function confirmOrder() {
      const billingAddress = document.getElementById('billingAddress').value.trim();
      orderData.billingAddress = billingAddress || orderData.shippingAddress;
      
      showModal(
        '<i class="fas fa-spinner fa-spin me-2"></i>Processing Order',
        '<div class="text-center"><div class="spinner-border text-primary mb-3" role="status"></div><p>Please wait while we process your order...</p></div>',
        ''
      );
      
      processOrder();
    }

    function processOrder() {
      const orderItems = cart.map(item => ({
        dish: item.dishId,
        quantity: item.quantity || 1,
        price: item.price
      }));

      let userData = {};
      try {
        const userString = localStorage.getItem('user');
        if (userString && userString !== 'undefined' && userString !== 'null') {
          userData = JSON.parse(userString);
        }
      } catch (error) {
        console.error('Error parsing user data:', error);
        userData = {};
      }

      fetch('http://localhost:3001/order/addOrder', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          orderItems: orderItems,
          user: userData.id,
          shippingAddress: orderData.shippingAddress,
          billingAddress: orderData.billingAddress
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.message && data.order && data.order._id) {
          localStorage.removeItem("cart");
          cart = [];
          renderCart();
          showModal(
            '<i class="fas fa-check-circle me-2 text-success"></i>Order Placed Successfully!',
            '<div class="text-center"><div class="modal-icon text-success"><i class="fas fa-check-circle"></i></div><h4 class="mb-3">Thank you for your order!</h4><p class="text-muted">Your order has been placed successfully.</p><div class="alert alert-info"><strong>Order ID:</strong> ' + data.order._id + '</div></div>',
            '<button type="button" class="btn btn-primary-modal" onclick="window.location.href=\'user-dashboard.html\'">Continue Shopping</button>'
          );
        } else {
          showModal(
            '<i class="fas fa-exclamation-triangle me-2 text-danger"></i>Order Failed',
            '<div class="text-center"><div class="modal-icon text-danger"><i class="fas fa-exclamation-triangle"></i></div><h4 class="mb-3">Something went wrong</h4><p class="text-muted">' + (data.message || "Invalid response from server") + '</p></div>',
            '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary-modal" onclick="placeOrder()">Try Again</button>'
          );
        }
      })
      .catch(error => {
        showModal(
          '<i class="fas fa-exclamation-triangle me-2 text-danger"></i>Order Failed',
          '<div class="text-center"><div class="modal-icon text-danger"><i class="fas fa-exclamation-triangle"></i></div><h4 class="mb-3">Network Error</h4><p class="text-muted">Please try again or contact support if the problem persists.</p></div>',
          '<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button><button type="button" class="btn btn-primary-modal" onclick="placeOrder()">Try Again</button>'
        );
      });
    }

    renderCart();
  </script>
</body>
</html>


