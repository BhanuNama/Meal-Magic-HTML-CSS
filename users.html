<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Meal Magic - Users</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="admin-common.css" rel="stylesheet">
</head>
<body>
  <nav class="navbar navbar-light bg-white px-4 shadow-sm">
    <a class="navbar-brand" href="admin-dashboard.html">Meal Magic</a>
    <button class="btn btn-danger logout-btn" data-bs-toggle="modal" data-bs-target="#logoutModal">
      <i class="fas fa-sign-out-alt"></i> Logout
    </button>
  </nav>

  <div class="container mt-4">
    <h3 class="fw-bold">Users</h3>
    <p class="text-muted">Manage application users</p>

    <!-- Top Navigation Buttons -->
    <div class="top-nav d-flex gap-2 flex-wrap mb-4">
      <a class="btn btn-outline-secondary" href="admin-dashboard.html"><i class="fas fa-utensils"></i> Menu</a>
      <a class="btn btn-outline-secondary" href="admin-orders.html"><i class="fas fa-shopping-cart"></i> Orders</a>
      <a class="btn btn-outline-primary active" href="users.html"><i class="fas fa-users"></i> Users</a>
      <a class="btn btn-outline-secondary" href="revenue.html"><i class="fas fa-chart-line"></i> Revenue</a>
    </div>

    <div class="card shadow-sm p-3">
      <div class="table-responsive">
        <table class="table align-middle">
          <thead><tr><th>ID</th><th>Username</th><th>Email</th><th>Phone</th><th>Role</th><th>Join Date</th></tr></thead>
          <tbody id="users-table"><tr><td colspan="6" class="text-center">Loading users...</td></tr></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Success Modal -->
  <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-4">
          <div class="mb-3"><i class="fas fa-check-circle text-success" style="font-size: 3rem;"></i></div>
          <h5 class="mb-3" id="successTitle">Success!</h5>
          <p class="mb-4" id="successMessage"></p>
          <button type="button" class="btn btn-success" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Error Modal -->
  <div class="modal fade" id="errorModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-body text-center p-4">
          <div class="mb-3"><i class="fas fa-exclamation-triangle text-danger" style="font-size: 3rem;"></i></div>
          <h5 class="mb-3" id="errorTitle">Error!</h5>
          <p class="mb-4" id="errorMessage"></p>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">OK</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Logout Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content text-center">
        <div class="modal-body p-4">
          <p class="fs-5 mb-4">Are you sure you want to logout?</p>
          <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
          <button type="button" id="confirmLogout" class="btn btn-danger">Yes, Logout</button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="admin-shared.js"></script>
  <script>
    let users = [];
    const usersTableBody = document.getElementById('users-table'),
          errorModal = new bootstrap.Modal(document.getElementById('errorModal'));

    const showErrorModal = window.AdminShared.showErrorModal;

    async function loadUsers() {
      try {
        const response = await fetch('http://localhost:3001/user/getAllUsers');
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
        const data = await response.json();
        users = data.data || [];
        renderUsersTable();
      } catch (error) {
        console.error('Could not fetch users:', error);
        usersTableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Failed to load users.</td></tr>';
      }
    }

    function renderUsersTable() {
      const regularUsers = users.filter(user => user.userRole !== 'admin');
      usersTableBody.innerHTML = regularUsers.map((user, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${user.username}</td>
          <td>${user.email}</td>
          <td>${user.mobileNumber}</td>
          <td><span class="badge bg-primary">${user.userRole}</span></td>
          <td>${user.createdAt ? new Date(user.createdAt).toLocaleDateString() : 'N/A'}</td>
        </tr>`).join('');
    }

    window.AdminShared.bindLogout('logoutModal', 'confirmLogout');

    loadUsers();
  </script>
</body>
</html>


